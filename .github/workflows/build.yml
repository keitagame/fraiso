name: Build ISO with build.sh (Arch)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare pacman cache dir
        run: mkdir -p .cache/pacman

      - name: Cache pacman packages
        uses: actions/cache@v4
        with:
          path: .cache/pacman
          key: pacman-${{ runner.os }}-${{ hashFiles('build.sh', '**/*.pkglist', '**/packages.*', '**/*.yaml', '**/*.yml') }}
          restore-keys: |
            pacman-${{ runner.os }}-

      - name: Pull Arch container
        run: docker pull archlinux:latest

      - name: Run build.sh inside privileged Arch container
        run: |
          docker run --rm --privileged \
            -v "${GITHUB_WORKSPACE}:/work" \
            -v "${GITHUB_WORKSPACE}/.cache/pacman:/var/cache/pacman/pkg" \
            -w /work \
            archlinux:latest bash -lc '
              set -euo pipefail
              sed -i "s/^#ParallelDownloads.*/ParallelDownloads = 10/" /etc/pacman.conf
              pacman -Sy --noconfirm archlinux-keyring
              pacman -Syu --noconfirm
              pacman -S --noconfirm \
                archiso yq git sudo \
                squashfs-tools xorriso dosfstools e2fsprogs \
                systemd mkinitcpio
              chmod +x ./ownbuild.sh
              ./ownbuild.sh
            '
      - run: sudo chown -R $USER:$USER out

      - name: Generate checksums
        if: always()
        
        run: |
          if ls out/*.iso >/dev/null 2>&1; then
            (cd out && sha256sum *.iso > SHA256SUMS.txt)
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.run_number }}"
          name: "ISO Build ${{ github.run_number }}"
          body: |
            自動ビルドしたArch LinuxカスタムISOです。
            - ブートは可能
            - SHA256SUMS同梱
          files: |
            out/*.iso
            out/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
